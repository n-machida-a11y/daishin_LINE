/**
 * LINE WORKS Bot (API 2.0) ç”¨ GASã‚³ãƒ¼ãƒ‰ (ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦ç‰ˆ)
 * * â˜… ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ ã¯ä¸è¦ã§ã™ã€‚æ¨™æº–æ©Ÿèƒ½ã ã‘ã§å‹•ä½œã—ã¾ã™ã€‚
 */

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®èª­ã¿è¾¼ã¿
const PROPS = PropertiesService.getScriptProperties();

// è¨­å®šå€¤ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å–å¾—ï¼‰
const TARGET_USER_ID = PROPS.getProperty('USER_ID'); // ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
const BOT_ID = PROPS.getProperty('BOT_ID');

/**
 * ãƒ­ã‚°ã‚’ã€ŒDebugã€ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€é–¢æ•°
 */
function debugLog(text) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('Debug');
    if (!sheet) {
      sheet = ss.insertSheet('Debug'); // ãªã‘ã‚Œã°ä½œã‚‹
      sheet.appendRow(['æ—¥æ™‚', 'ãƒ­ã‚°å†…å®¹']); // ãƒ˜ãƒƒãƒ€ãƒ¼
    }
    sheet.appendRow([new Date(), text]);
  } catch (e) {
    console.error("ãƒ­ã‚°æ›¸ãè¾¼ã¿å¤±æ•—: " + e.toString());
  }
}

/**
 * 1. LINE WORKSã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹é–¢æ•° (Webhook)
 */
function doPost(e) {
  debugLog("ğŸš€ doPostå—ä¿¡é–‹å§‹");

  if (!e || !e.postData) {
    debugLog("âŒ ã‚¨ãƒ©ãƒ¼: postDataãŒã‚ã‚Šã¾ã›ã‚“");
    return ContentService.createTextOutput("No postData");
  }

  let eventData;
  try {
    eventData = JSON.parse(e.postData.contents);
    debugLog("ğŸ“© å—ä¿¡ãƒ‡ãƒ¼ã‚¿: " + e.postData.contents);
  } catch (error) {
    debugLog("âŒ JSONè§£æã‚¨ãƒ©ãƒ¼: " + error.toString());
    return ContentService.createTextOutput("Error: Invalid JSON").setMimeType(ContentService.MimeType.TEXT);
  }

  const senderId = eventData.source ? eventData.source.userId : "ä¸æ˜";

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯
  if (senderId === TARGET_USER_ID) {
    debugLog("âœ… ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è‡´: " + senderId);

    if (eventData.type === 'message' && eventData.content.type === 'text') {
      const messageText = eventData.content.text;

      try {
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆï¼‰ã«æ›¸ãè¾¼ã¿
        const sheet = SpreadsheetApp.getActive().getActiveSheet();
        sheet.appendRow([
          new Date(),
          messageText
        ]);
        debugLog("ğŸ“ ãƒ¡ã‚¤ãƒ³ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿å®Œäº†: " + messageText);
        SpreadsheetApp.flush(); 

      } catch (sheetError) {
        debugLog("âŒ ãƒ¡ã‚¤ãƒ³ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + sheetError.toString());
        sendMessage(senderId, "âš ï¸ ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿å¤±æ•—\n" + sheetError.toString());
        return ContentService.createTextOutput("Sheet Error").setMimeType(ContentService.MimeType.TEXT);
      }

      // å¤–éƒ¨é–¢æ•°ã®å‘¼ã³å‡ºã—
      if (typeof processAppSheetEntries === 'function') {
        debugLog("ğŸ”„ processAppSheetEntries ã‚’å®Ÿè¡Œã—ã¾ã™");
        try {
          processAppSheetEntries();
          debugLog("âœ… processAppSheetEntries å®Œäº†");
        } catch (err) {
          debugLog("âŒ processAppSheetEntries ã‚¨ãƒ©ãƒ¼: " + err.toString());
          sendMessage(senderId, "âš ï¸ é€£æºå‡¦ç†ã‚¨ãƒ©ãƒ¼:\n" + err.toString());
        }
      } else {
        debugLog("âš ï¸ processAppSheetEntriesé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }

      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);

    } else {
      debugLog("â„¹ï¸ ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: " + eventData.type);
      sendMessage(senderId, "â„¹ï¸ ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚");
      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
    }

  } else {
    // IDä¸ä¸€è‡´ã®å ´åˆ
    debugLog("ğŸš« IDä¸ä¸€è‡´æ‹’å¦: é€ä¿¡è€…=" + senderId + " / è¨­å®šå€¤=" + TARGET_USER_ID);
    sendMessage(senderId, "âš ï¸ ã‚¨ãƒ©ãƒ¼: IDãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚\n\nã‚ãªãŸã®ID: " + senderId + "\nè¨­å®šã•ã‚ŒãŸID: " + TARGET_USER_ID + "\n\nGASã®USER_IDã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
    return ContentService.createTextOutput("Ignored").setMimeType(ContentService.MimeType.TEXT);
  }
}

/**
 * 2. ãƒ†ã‚¹ãƒˆé€ä¿¡ç”¨ã®é–¢æ•°
 */
function sendTestMessage() {
  const userId = PROPS.getProperty('USER_ID');
  debugLog("ğŸ”§ ãƒ†ã‚¹ãƒˆé€ä¿¡å®Ÿè¡Œ: " + userId + " å®›ã¦");
  
  if (!userId) {
    debugLog("âŒ ã‚¨ãƒ©ãƒ¼: USER_IDæœªè¨­å®š");
    return;
  }
  sendMessage(userId, "GASã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆé€ä¿¡æˆåŠŸã§ã™ï¼Botã®è¨­å®šã¯æ­£å¸¸ã§ã™ã€‚ğŸ‰");
}

/**
 * 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®å®Ÿè¡Œé–¢æ•°
 */
function sendMessage(userId, text) {
  try {
    const token = getAccessToken();
    const botId = PROPS.getProperty('BOT_ID');
    const url = `https://www.worksapis.com/v1.0/bots/${botId}/users/${userId}/messages`;
    
    const payload = {
      content: {
        type: 'text',
        text: text
      }
    };

    const options = {
      method: 'post',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(url, options);
    const resCode = response.getResponseCode();
    
    if (resCode === 201) {
      debugLog("ğŸ“¤ é€ä¿¡æˆåŠŸ: " + text);
    } else {
      debugLog("âŒ é€ä¿¡å¤±æ•— (Code " + resCode + "): " + response.getContentText());
    }
    
  } catch (e) {
    debugLog("âŒ sendMessageé–¢æ•°ã‚¨ãƒ©ãƒ¼: " + e.toString());
  }
}

/**
 * 4. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–¢æ•° (ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸ä½¿ç”¨ç‰ˆ)
 * GASæ¨™æº–æ©Ÿèƒ½ã®ã¿ã§JWTã‚’ç”Ÿæˆã—ã¾ã™
 */
function getAccessToken() {
  const privateKey = PROPS.getProperty('PRIVATE_KEY');
  const clientId = PROPS.getProperty('CLIENT_ID');
  const serviceAccount = PROPS.getProperty('SERVICE_ACCOUNT');
  
  if (!privateKey || !clientId || !serviceAccount) {
    throw new Error("ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šä¸å‚™");
  }

  // 1. ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
  const header = {
    alg: 'RS256',
    typ: 'JWT'
  };

  // 2. ã‚¯ãƒ¬ãƒ¼ãƒ ã‚»ãƒƒãƒˆä½œæˆ
  const now = Math.floor(Date.now() / 1000);
  const claim = {
    iss: clientId,
    sub: serviceAccount,
    iat: now,
    exp: now + 3600
  };
  
  // 3. ç½²åç”Ÿæˆ (ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãšGASæ¨™æº–æ©Ÿèƒ½ã§å®Ÿè£…)
  const toSign = base64UrlEncode(JSON.stringify(header)) + '.' + base64UrlEncode(JSON.stringify(claim));
  const signatureBytes = Utilities.computeRsaSha256Signature(toSign, privateKey);
  const signature = base64UrlEncode(signatureBytes);
  const jwt = toSign + '.' + signature;

  // 4. ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚
  const url = 'https://auth.worksmobile.com/oauth2/v2.0/token';
  const payload = {
    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
    assertion: jwt,
    client_id: clientId,
    client_secret: PROPS.getProperty('CLIENT_SECRET'),
    scope: 'bot'
  };

  const options = {
    method: 'post',
    payload: payload,
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());
  
  if (json.error) {
    throw new Error("ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—APIã‚¨ãƒ©ãƒ¼: " + json.error);
  }
  return json.access_token;
}

/**
 * ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: Base64URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
 */
function base64UrlEncode(input) {
  let bytes;
  if (typeof input === 'string') {
    bytes = Utilities.newBlob(input).getBytes();
  } else {
    bytes = input;
  }
  return Utilities.base64Encode(bytes)
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}
